<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Live Crypto Tracker test (D3.js)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; background: #f4f4f9; }
        .line { fill: none; stroke: #4285f4; stroke-width: 3; }
        .area { fill: #4285f4; opacity: 0.1; }
        svg { background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    </style>
</head>
<body>
    <h2>Live Bitcoin Price (Updates every 30s)</h2>
    <div id="chart"></div>

    <script>
        const margin = {top: 20, right: 30, bottom: 30, left: 60},
              width = 600 - margin.left - margin.right,
              height = 400 - margin.top - margin.bottom;

        let data = []; // This will store our time-series points

        const svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const x = d3.scaleTime().range([0, width]);
        const y = d3.scaleLinear().range([height, 0]);

        const line = d3.line()
            .x(d => x(d.time))
            .y(d => y(d.price))
            .curve(d3.curveMonotoneX);

        async function fetchPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd');
                const result = await response.json();
                const price = result.bitcoin.usd;
                const time = new Date();

                data.push({ time, price });

                // Keep only the last 20 data points to prevent memory lag
                if (data.length > 20) data.shift();

                updateChart();
            } catch (e) { console.error("API Fetch Failed", e); }
        }

        function updateChart() {
            x.domain(d3.extent(data, d => d.time));
            y.domain([d3.min(data, d => d.price) * 0.999, d3.max(data, d => d.price) * 1.001]);

            svg.selectAll(".axis").remove();
            svg.append("g").attr("class", "axis").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x));
            svg.append("g").attr("class", "axis").call(d3.axisLeft(y));

            const path = svg.selectAll(".line-path").data([data]);
            path.enter().append("path").attr("class", "line-path line")
                .merge(path)
                .transition().duration(500)
                .attr("d", line);
        }

        // Initial fetch and set interval
        fetchPrice();
        setInterval(fetchPrice, 30000); // 30 seconds to respect API rate limits
    </script>
</body>
</html>
